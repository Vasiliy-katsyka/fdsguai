let clickCount = 0;
let clickMultiplier = 1;
let upgradeCosts = [500, 1500, 5000]; // Increased initial costs
let upgradeLevel = [0, 0, 0]; // Array to track upgrade levels

// Update click count display
function updateClickCount() {
  document.getElementById('clickCount').textContent = clickCount;
  document.getElementById('clicksPerTap').textContent = clickMultiplier;
}

// Function to handle coin click
function clickCoin() {
  clickCount += clickMultiplier;
  updateClickCount();
  saveBalance(); // Save balance after every click
  showClickText(clickMultiplier); // Show the click text
}

// Function to open the popup
function openPopup() {
  document.getElementById('popup').style.display = 'block';
  updateUpgradeCosts(); // Update costs when popup opens
}

// Function to close the popup
function closePopup() {
  document.getElementById('popup').style.display = 'none';
}

// Function to handle click upgrade
function upgradeClick() {
  let upgradeAmount = parseInt(document.getElementById('upgradeAmount').value);
  let upgradeIndex = 0; // Start with the first upgrade

  // Loop through upgrades to find the cheapest affordable one
  while (upgradeIndex < upgradeCosts.length) {
    if (clickCount >= upgradeCosts[upgradeIndex] * upgradeAmount) {
      // Buy the upgrade
      clickCount -= upgradeCosts[upgradeIndex] * upgradeAmount;
      clickMultiplier += (upgradeIndex + 1) * upgradeAmount; // Increase multiplier based on level
      upgradeLevel[upgradeIndex] += upgradeAmount; // Increase upgrade level
      updateClickCount();
      updateUpgradeCosts(); // Update costs after upgrade
      break; // Exit the loop after buying an upgrade
    }
    upgradeIndex++;
  }
}

// Function to update upgrade costs
function updateUpgradeCosts() {
  for (let i = 0; i < upgradeCosts.length; i++) {
    upgradeCosts[i] = 500 + (upgradeLevel[i] * 200); // Increased cost increase rate
    document.getElementById(`upgradeCost${i + 1}`).textContent = 'Cost: ' + upgradeCosts[i] + ' clicks';
  }
}

// Function for "Mining" button
function miningClick() {
  // Placeholder for future mining logic
  alert("Mining feature is under development!");
}

// Function for "Earn" button
function earnClick() {
  // Add 5k clicks
  clickCount += 5000;
  updateClickCount();
  saveBalance(); // Save the new balance
  alert("You earned 5,000 clicks! Thanks for subscribing!");
}

// Function for "About" button
function aboutClick() {
  // Display information about the creator
  alert("KVCoin created by Vasiliy Katsyka");
}

// Function to show click text above the coin
function showClickText(clicks) {
  let clickText = document.getElementById('clickText');
  clickText.textContent = `+${clicks}`;
  clickText.classList.remove('fly-up'); // Reset the class

  // Add a small delay before applying the fly-up class
  setTimeout(() => {
    clickText.classList.add('fly-up');
  }, 100);
}

// Function to load the user's balance from local storage
async function loadBalance(userId) {
  const balance = localStorage.getItem(`balance_${userId}`);
  return balance ? parseInt(balance) : 0;
}

// Function to save the user's balance to local storage
async function saveUserBalance(userId, balance) {
  localStorage.setItem(`balance_${userId}`, balance);
}

// Function to initialize the game (load balance from local storage)
async function initializeGame() {
  const userId = Telegram.WebApp.WebAppUser.id;
  try {
    const balance = await loadBalance(userId);
    clickCount = balance;
    updateClickCount();
  } catch (error) {
    console.error("Error loading balance:", error);
  }
}

// Function to save the user's balance
async function saveBalance() {
  const userId = Telegram.WebApp.WebAppUser.id;
  try {
    await saveUserBalance(userId, clickCount);
  } catch (error) {
    console.error("Error saving balance:", error);
  }
}

// Add event listener to the coin for mobile
const coin = document.querySelector('.coin');
coin.addEventListener('click', clickCoin);

// Initialize the game
initializeGame();
